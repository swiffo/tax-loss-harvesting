# Tax Loss Harvesting

## Synopsis

## Preparations
### Data load and preprocessing
Load in the data from Yahoo and sort by date.
```{r, cache=TRUE}
library(dplyr)
library(ggplot2)

SPY <- read.csv('http://ichart.finance.yahoo.com/table.csv?s=SPY&a=1&b=1&c=2005&g=d&ignore=.csv')
SPY$Date <- as.Date(as.character(SPY$Date))
SPY$Year <- format(SPY$Date, "%Y")
SPY <- arrange(SPY, Date)

ggplot(SPY, aes(x=Date, y=Close)) + geom_line()
```

### Some useful definitions
#### Constants
Tax rates are based on Denmark.
```{r}
capitalGainsTax <- 0.27
marginalTax <- 0.56
```

#### Some useful functions
```{r}
taxadjusted_value <- function(start_value, end_value) {
  gainloss <- end_value - start_value
  taxadjusted_gainloss <- pmax(0,gainloss)*(1-capitalGainsTax) + pmin(0,gainloss)*(1-marginalTax)
  return(start_value + taxadjusted_gainloss)
}
```

## Buy and hold
We find the PNL for buy and hold. 

```{r}
library(dplyr)
library(ggplot2)
start <- SPY[1,]$Close

SPY <- (
  SPY 
  %>% mutate(
    taxadjustedPNL = taxadjusted_value(start, Close)
  )
)

(ggplot(data=SPY) 
  + aes(Date)
  + geom_line(aes(y=Close, colour='zero tax')) 
  + geom_line(aes(y=taxadjustedPNL, colour='adjusted'))
  + ylab('SPY')
  + ggtitle('Buy and Hold')
  + scale_color_manual(name='Legend',values=c('zero tax'='blue',adjusted='orange'))
 )
```

## Upper Bound for Tax Harvesting
In the following we assume we have an infinite number of securities with identical behaviour but which are treated as different for tax purposes. Losses are all tax-deductible and gains all taxed independently of each other. We employ a psychic person to trade at close with no transaction costs.

This serves to construct an upper bound for the benefits of tax harvesting.

### Split PNL into loss and gain
We first create a data frame with daily PNL deltas.
```{r}
dates <- SPY$Date
vals <- SPY$Close
deltas <- data.frame(
  Date=dates[2:length(dates)],
  Close=vals[2:length(dates)],
  prevClose=vals[1:length(dates)-1]
)
deltas$Delta <- deltas$Close - deltas$prevClose
```

```{r}
deltas <- select(deltas,Date,Delta)
SPY <- left_join(SPY, deltas, by='Date')
SPY[is.na(SPY$Delta),'Delta'] <- 0 # First entry has no previous entry and thus no delta
SPY <- mutate(
    SPY, 
    cumGain=cumsum(pmax(0,Delta)), 
    cumLoss=cumsum(pmin(0,Delta)),
    psychic_taxadjustedPNL=start + taxadjusted_value(0,cumGain) + taxadjusted_value(0,cumLoss)
  )
```

Plotting this upper bound:
```{r}
( ggplot(data=SPY)
  + aes(x=Date)
  + geom_line(aes(y=psychic_taxadjustedPNL, colour='psychic'))
  + geom_line(aes(y=Close, colour='Close'))
  + geom_line(aes(y=taxadjustedPNL, colour='B&H'))
  + ylab('PNL')
  + ggtitle('PNL by Strategy')
  + scale_color_manual(name='Legend',values=c(psychic='green',Close='orange', 'B&H'='violet'))
)
```

## An attempt at tax harvesting
Tax-loss harvesting consists of separating losses and gains into separate years to take advantage in the different tax rates used when reducing income tax and applying capital gains tax.

In order to realize as much loss as possible, we realize gains or losses at least once a year. Whether to make the year a loss-year or a gains-year depends on whether the PNL hits a pre-chosen lower or upper bound first.

```{r}
gain_bound <- 0.04
loss_bound <- -0.02
```

Set up starting conditions:
```{r}
row_count <- dim(SPY)[1]
first_row <- SPY[1,]
year <- first_row$Year
total_value <- first_row$Close
last_reset_close <- first_row$Close
pnl <- 0
realized_pnl <- 0
pnl_vector <- vector(mode="numeric", length=row_count)
pnl_vector$Name <- "pnl"
pnl_actualized <- 0 # -1 for loss, 0 for not actualized, 1 for gain
```

### Monty on the Run
```{r}
for(row_index in 1:row_count) {
  row <- SPY[row_index,]
  new_year <- row$Year
  pnl <- pnl + row$Delta
  
  if(new_year != year) {
    year <- new_year
    if(pnl_actualized==0 || sign(pnl_actualized)==sign(pnl)) {
      realized_pnl <- realized_pnl + taxadjusted_value(0,pnl)
      pnl <- 0
      last_reset_close <- row$Close
    } 
  }
  
  close_change <- (row$Close - last_reset_close) / last_reset_close - 1
  if(pnl_actualized==0 && (close_change <= loss_bound || close_change >= gain_bound) ) {
    pnl_actualized <- sign(pnl)
    realized_pnl <- realized_pnl + taxadjusted_value(0,pnl)
    pnl <- 0
  }
  
  pnl_vector[row_index] <- realized_pnl + taxadjusted_value(0,pnl)
}
```

Having the PNL vector we add it to the data frame.

```{r}
SPY <- cbind(SPY, pnl_vector)
```